<!DOCTYPE html>
<html lang="ru">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<head>
<meta charset="UTF-8">
<title>Books Reader</title>
<style>
body {
  margin: 0;
  font-family: sans-serif;
  background: #121212;
  color: #eee;
  display: flex;
  flex-direction: column;
  align-items: center;
}
a {
  color: #90caf9;
  text-decoration: none;
  display: block;
  margin: 10px 0;
}
#reader {
  display: none;
  flex-direction: column;
  align-items: center;
  width: 100%;
  position: relative;
}
#pageInput {
  margin: 10px;
  background: #1e1e1e;
  color: #eee;
  border: 1px solid #555;
  padding: 5px;
  width: 60px;
  text-align: center;
}
#pages {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  perspective: 1000px;
}
.pageWrapper {
  position: relative;
}
.pageWrapper img {
  max-height: 80vh;
  max-width: 45vw;
  background: #222;
  padding: 5px;
  border-radius: 5px;
  transform-style: preserve-3d;
  transition: transform 0.5s ease;
  display: block;
}
.overlayText {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  padding: 10px;
  color: #00ffcc;
  font-size: 14px;
  line-height: 1.4;
  background: rgba(0,0,0,0.3);
  overflow-y: auto;
  white-space: pre-wrap;
  user-select: text;
}
#controls {
  margin: 15px;
}
button {
  background: #333;
  color: #eee;
  border: none;
  padding: 8px 15px;
  margin: 5px;
  cursor: pointer;
  border-radius: 5px;
}
button:hover {
  background: #444;
}
#ocrBtn {
  position: absolute;
  top: 10px;
  right: 10px;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>

<h1>–ò–°-15</h1>
<div id="bookList"></div>

<div id="reader">
  <button id="backBtn">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–Ω–∏–≥–∞–º</button>
  <input type="number" id="pageInput" min="1" value="1">

  <button id="ocrBtn">–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ç–µ–∫—Å—Ç</button>

  <div id="pages">
    <div class="pageWrapper">
      <img id="pageLeft" src="">
      <div id="textLeft" class="overlayText"></div>
    </div>
    <div class="pageWrapper">
      <img id="pageRight" src="">
      <div id="textRight" class="overlayText"></div>
    </div>
  </div>

  <div id="controls">
    <button id="prevBtn">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
    <button id="nextBtn">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>
    <button id="downloadBtn">üì• –°–∫–∞—á–∞—Ç—å –∫–Ω–∏–≥—É</button>
  </div>
</div>

<audio id="flipSound" src="flip.mp3" preload="auto"></audio>

<script>
const { jsPDF } = window.jspdf;

// —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥
const books = {
  "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏": "books/–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏",
  "–í—Å–µ–æ–±—â–∞—è –∏—Å—Ç–æ—Ä–∏—è": "books/–ò—Å—Ç–æ—Ä–∏—è",
  "–ò—Å—Ç–æ—Ä–∏—è –†–æ—Å—Å–∏–∏": "books/–ò—Å—Ç–æ—Ä–∏—è1",
  "–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ": "books/–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ"
};

const bookListDiv = document.getElementById("bookList");
const readerDiv = document.getElementById("reader");
const backBtn = document.getElementById("backBtn");
const pageInput = document.getElementById("pageInput");
const pageLeft = document.getElementById("pageLeft");
const pageRight = document.getElementById("pageRight");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const downloadBtn = document.getElementById("downloadBtn");
const flipSound = document.getElementById("flipSound");

const textLeft = document.getElementById("textLeft");
const textRight = document.getElementById("textRight");
const ocrBtn = document.getElementById("ocrBtn");

let currentBook = null;
let currentPage = 1;

for (let [title, path] of Object.entries(books)) {
  const link = document.createElement("a");
  link.textContent = title;
  link.href = "#";
  link.onclick = () => openBook(path);
  bookListDiv.appendChild(link);
}

function openBook(path) {
  currentBook = path;
  currentPage = 1;
  bookListDiv.style.display = "none";
  readerDiv.style.display = "flex";
  loadPage(true);
}

function loadPage(animated = true) {
  pageInput.value = currentPage;

  textLeft.textContent = "";
  textRight.textContent = "";

  if (animated) {
    pageLeft.style.transform = "rotateY(180deg)";
    pageRight.style.transform = "rotateY(-180deg)";
    flipSound.currentTime = 0;
    flipSound.play();

    setTimeout(() => {
      pageLeft.src = `${currentBook}/${currentPage}.jpg`;
      pageRight.src = `${currentBook}/${currentPage + 1}.jpg`;

      pageLeft.style.transform = "rotateY(0deg)";
      pageRight.style.transform = "rotateY(0deg)";
    }, 250);
  } else {
    pageLeft.src = `${currentBook}/${currentPage}.jpg`;
    pageRight.src = `${currentBook}/${currentPage + 1}.jpg`;
  }
}

pageInput.onchange = () => {
  currentPage = parseInt(pageInput.value) || 1;
  loadPage();
};

prevBtn.onclick = () => {
  if (currentPage > 1) {
    currentPage -= 2;
    if (currentPage < 1) currentPage = 1;
    loadPage();
  }
};

nextBtn.onclick = () => {
  currentPage += 2;
  loadPage();
};

backBtn.onclick = () => {
  readerDiv.style.display = "none";
  bookListDiv.style.display = "block";
};

function loadImage(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = src;
  });
}

function imageExists(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => resolve(true);
    img.onerror = () => resolve(false);
    img.src = url;
  });
}

downloadBtn.onclick = async () => {
  if (!currentBook) return;

  const pdf = new jsPDF({ orientation: "landscape" });
  let pageNumber = 1;

  while (true) {
    const imgPath = `${currentBook}/${pageNumber}.jpg`;
    if (!await imageExists(imgPath)) break;

    const img = await loadImage(imgPath);

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgRatio = img.width / img.height;
    const pageRatio = pageWidth / pageHeight;

    let renderWidth, renderHeight, x, y;

    if (imgRatio > pageRatio) {
      renderWidth = pageWidth;
      renderHeight = pageWidth / imgRatio;
      x = 0;
      y = (pageHeight - renderHeight) / 2;
    } else {
      renderHeight = pageHeight;
      renderWidth = pageHeight * imgRatio;
      y = 0;
      x = (pageWidth - renderWidth) / 2;
    }

    pdf.addImage(img, "JPEG", x, y, renderWidth, renderHeight);

    pageNumber++;
    if (await imageExists(`${currentBook}/${pageNumber}.jpg`)) {
      pdf.addPage();
    }
  }

  pdf.save(currentBook.split("/").pop() + ".pdf");
};

ocrBtn.onclick = async () => {
  if (!pageLeft.src && !pageRight.src) return;

  textLeft.textContent = "–†–∞—Å–ø–æ–∑–Ω–æ–≤–∞–Ω–∏–µ...";
  textRight.textContent = "–†–∞—Å–ø–æ–∑–Ω–æ–≤–∞–Ω–∏–µ...";

  if (pageLeft.src) {
    const { data: { text } } = await Tesseract.recognize(pageLeft.src, 'rus+eng');
    textLeft.textContent = text.trim();
  }

  if (pageRight.src) {
    const { data: { text } } = await Tesseract.recognize(pageRight.src, 'rus+eng');
    textRight.textContent = text.trim();
  }
};
</script>

</body>
</html>




